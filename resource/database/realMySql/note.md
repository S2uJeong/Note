# 아키텍처

## MySQL 엔진 아키텍처

![image-20241221151159199](https://raw.githubusercontent.com/S2uJeong/blogImages/main/images/image-20241221151159199.png)

- MySQL 엔진

    - 요청된 SQL 문장을 분석하거나 최적화 하는 등 <u>DBMS의 두뇌에 해당하는 처리</u>를 수행
    - MySQL 서버에서 엔진은 하나

- 스토리지 엔진

    - 실제 데이터를 디스크 스토리지에 <u>저장</u>하거나 디스크 스토리지로부터 <u>데이터를 읽어오는</u>
    - 스토리지 엔진은 여러 개를 동시에 사용 가능

- 핸들러

    - 엔진이 각 스토리지 엔진에서 데이터를 읽어오거나 저장하도록 명령하려면 핸들러를 거쳐야 한다.



### MySQL 스레딩 구조

- MySQL 서버는 프로세스 기반이 아니라 스레드 기반으로 작동한다.
- 크게 포그라운드/백그라운드 스레드로 구분한다.
    - 포그라운드(클라이언트) : 서버에 접속된 클라의 수만큼 존재

![image-20241221151619879](https://raw.githubusercontent.com/S2uJeong/blogImages/main/images/image-20241221151619879.png)

- 실행중인 스레드 목록 확인하는 쿼리

  ```mysql
  select thread_id, name, type, peocesslist_user, processlist_host
  from performance_shems.threads
  ORDER BY type, thread_id;
  ```

- 동일한 이름의 스레드가 2개 이상씩 보이는 것은 여러 스레드가 동일 작업을 병렬로 처리 하는 경우



### 쿼리 실행 구조

![image-20241221153059285](https://raw.githubusercontent.com/S2uJeong/blogImages/main/images/image-20241221153059285.png)

## InnoDB 스토리지 엔진 아키텍처

- InnoDB는 MySQL 에서 사용할 수 있는 스토리지 엔진 중
- 거의 유일한 레코드 기반의 잠금을 제공
- 그 때문에 높은 동시성 처리가 가능하고 안정적

### 주요 특징

- PK에 의한 클러스터링
    - 모든 세컨더리 인덱스는 레코드 주소 대신 PK 값을 논리적 주소로 이용 -
    - 이를 통해 레인지 스캔이 상장히 빨라짐
- 외래키 지원
- MVCC (Multi Version Concurrency Control)
    - Multi Version : 하나의 레코드에 대해 여러 버전이 동시에 관리된다.
    - 레코드 레벨의 트랜잭션을 지원 하는 DBMS가 제공하는 기능
    - 주요 목적은 잠금을 사용하지 않는 일관된 읽기이다.
    - InnoDB는 언두 로그를 이용해 이 기능을 구현
    - [참고링크](https://velog.io/@strangehoon/MySQL-InnoDB%EC%97%90%EC%84%9C%EB%8A%94-%EA%B3%BC%EC%97%B0-Phantom-Read-%ED%98%84%EC%83%81%EC%9D%B4-%EB%B0%9C%EC%83%9D%ED%95%A0%EA%B9%8C)
- 자동 데드락 감지
    - 교착 상태를 방지 하기 위해 잠금 대기 목록을 그래프(Wait-for List) 형태로 관리한다.
    - 어느 트랜잭션을 먼저 강제 종료할 것인지 판단하는 기준은 언두 로그 양.
    - 언두 로그 양이 더 적은 트랜잭션이 롤백의 대상이 된다.
- 버퍼 풀
    - 디스크의 데이터 파일이나 인덱스 정보를 메모리에 캐시해 두는 공간
    - 쓰기 작업을 지연시켜 일괄 작업으로 처리할 수 있게 해주는 버퍼역할도 한다.
    - 쿼리는 데이터 파일의 이곳저곳에 위치한 레코드를 변경하기 때문에 랜덤한 디스크 작업을 발생시킨다
    - 하지만 버퍼 풀이 이러한 변경된 데이터를 모아서 처리하면 랜덤함 디스크 작업의 횟수를 줄이 수 있다.
    - 성능향상 : 캐시, 버퍼링
        - 버퍼 풀 메모리 크기를 늘리면 캐싱 기능이 향상 됨
        - 쓰기 버퍼링 기능 까지 향상시키려면 리두로그도 관리해야 함



# 트랜잭션과 잠금

- 네트워크를 통해 원격 서버와 통신하는 등과 같은 작업은 어떻게 해서든 DBMS의 트랜잭션 내에서 제거해야 한다.
- 프로그램이 실행되는 동안 메일 서버와 통신할 수 없는 상황이 발생한다면 웹 서버뿐아니라 DBMS 서버까지 위험해진다. 

